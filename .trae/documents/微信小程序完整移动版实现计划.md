## 项目目标
- 新建 `miniprogram` 文件夹，构建与现有 Flask 项目“功能等价、UI风格一致”的微信小程序移动端版本。
- 通过新增后端 API（JSON）与小程序前端交互，保持数据与权限逻辑不变。

## 现有功能盘点（按角色）
- 学生：登录/注册、个人信息、我的宿舍、报修管理（提交/列表）、访客登记/记录、水电费账单与支付、宿舍调换申请/记录。
- 宿管：仪表盘、本楼栋学生/宿舍列表、报修管理（处理状态）、访客管理（标记离开）、宿舍调换申请审批、密码重置申请处理。
- 管理员：仪表盘、学生管理（增删改查/批量导入）、宿管管理、宿舍管理（增改）、智能分配、账单管理（增改删/统计）、支付记录、报修/访客管理、邀请码管理、密码重置申请处理。

## 技术方案
- 前端：使用微信小程序（WXML/WXSS/JS），抽象公共组件（卡片、表单、Tabs、列表项、状态徽标），统一主题色与排版以匹配原网站风格但适配移动端。
- 后端：新增 `app/api` 蓝图，提供 JSON API。沿用 `flask-login` 会话登录，采用 Cookie 维持会话（小程序端保存并在后续请求中附带 `Cookie`）。对 API 路由豁免 CSRF。

## 目录结构（新建）
- `miniprogram/`
  - `app.json`（路由配置）
  - `project.config.json`（项目配置）
  - `app.js`（全局逻辑，设置 `baseUrl`）
  - `app.wxss`（全局样式与主题）
  - `images/`（默认头像、占位图）
  - `services/`
    - `request.js`（请求封装，自动带上 Cookie 与错误处理）
    - `auth.js`（登录态守卫与重定向）
  - `components/`
    - `card/`、`status-badge/`、`form-group/`、`tabbar/` 等
  - `pages/`
    - `login/`、`register/`
    - 学生端：`index/`、`profile/`、`dorm/`、`repair/`、`bill/`、`visitor/`、`dorm_change/`
    - 宿管端：`dm_dashboard/`、`dm_students/`、`dm_dorms/`、`dm_repairs/`、`dm_visitors/`、`dm_dorm_changes/`、`dm_password_resets/`
    - 管理员端：`admin_dashboard/`、`admin_students/`、`admin_dorm_managers/`、`admin_dorms/`、`admin_smart_allocate/`、`admin_bills/`、`admin_bill_edit/`、`admin_bill_stats/`、`admin_payments/`、`admin_repairs/`、`admin_visitors/`、`admin_inv_codes/`、`admin_password_resets/`

## 页面与功能映射（代表性示例）
- 学生端
  - `login`：用户名+密码+用户类型选择；登录成功保存 Cookie 与用户信息。
  - `index`：欢迎 Banner + 功能网格；入口到各功能页。
  - `profile`：基本信息与宿舍信息展示；头像上传（`wx.uploadFile`）。
  - `dorm`：宿舍卡片（宿舍号、楼栋、楼层、入住统计）+ 室友列表；支持跳转到调宿页。
  - `repair`：历史报修列表 + 新报修表单（位置类型、维修类型、详情、电话、紧急程度）。
  - `bill`：账单列表卡片；未缴费显示“立即支付”按钮（模拟支付）。
  - `visitor`：Tab 切换（记录/登记），登记成功生成二维码并展示图片。
  - `dorm_change`：Tab 切换（申请记录/提交申请）。
- 宿管端
  - `dm_dashboard`：当前楼栋的统计卡片（学生数、宿舍数、待处理报修、在访访客）+ 最近活动时间线。
  - `dm_students/dm_dorms`：列表页 + 详情弹层/折叠卡。
  - `dm_repairs`：更改报修状态；`processing/completed`。
  - `dm_visitors`：标记离开；展示详情。
  - `dm_dorm_changes`：审批（通过/拒绝）。
  - `dm_password_resets`：密码重置审批并发送邮件（沿用后端逻辑）。
- 管理员端
  - `admin_dashboard`：统计与最新活动。
  - `admin_students`：增删改查 + CSV 批量导入。
  - `admin_dorm_managers`：增删改。
  - `admin_dorms`：宿舍增改；`admin_smart_allocate` 智能分配操作页。
  - `admin_bills`：增改删；`admin_bill_stats` 图表统计；`admin_payments` 支付记录。
  - `admin_repairs/admin_visitors`：列表与详情；状态/离开标记。
  - `admin_inv_codes`：邀请码生成与列表。
  - `admin_password_resets`：审批与邮件发送。

## 后端 API 设计（蓝图 `app/api`）
- 认证
  - `POST /api/login`（用户名、密码、用户类型）
  - `POST /api/logout`
- 学生
  - `GET /api/student/info`
  - `GET /api/student/dorm`（宿舍信息+室友）
  - `POST /api/student/photo`（上传头像）
  - `GET /api/repairs`、`POST /api/repairs`
  - `GET /api/utility_bills`、`POST /api/utility_bills/pay`
  - `GET /api/visitors`、`POST /api/visitors`
  - `GET /api/dorm_changes`、`POST /api/dorm_changes`
- 宿管
  - `GET /api/dm/dashboard`（统计与活动）
  - `GET /api/dm/students`、`GET /api/dm/dormitories`
  - `GET /api/dm/repairs`、`POST /api/dm/repairs/process`
  - `GET /api/dm/visitors`、`POST /api/dm/visitors/leave`
  - `GET /api/dm/dorm_changes`、`POST /api/dm/dorm_changes/{id}/approve|reject`
  - `GET /api/dm/password_resets`、`POST /api/dm/password_resets/{id}/approve|reject`
- 管理员
  - `GET /api/admin/dashboard`
  - 学生管理：`GET/POST/PUT/DELETE /api/admin/students`、`POST /api/admin/students/import`
  - 宿管管理：`GET/POST/PUT/DELETE /api/admin/dorm_managers`
  - 宿舍管理：`GET/POST/PUT /api/admin/dormitories`
  - 智能分配：`POST /api/admin/smart_allocate`
  - 账单管理：`GET/POST/PUT/DELETE /api/admin/utility_bills`、`GET /api/admin/utility_bills/statistics`
  - 支付记录：`GET /api/admin/payments`
  - 报修/访客：`GET /api/admin/repairs`、`GET /api/admin/visitors`
  - 邀请码：`GET/POST /api/admin/invitation_codes`
  - 密码重置：`GET /api/admin/password_resets`、`POST /api/admin/password_resets/{id}/approve|reject`

## 数据与状态管理
- 在 `services/request.js` 中统一封装 `wx.request`，自动注入 `Cookie`，以及失败重试/错误提示。
- 使用本地存储（`wx.setStorageSync`）持久化登录态与基础用户信息；页面 `onShow` 加守卫重定向到 `login`。

## 样式与适配策略
- 统一主题：主色 `#007aff`，卡片、阴影、栅格。
- 文本与间距：移动端字号（28~34rpx）、组件触控反馈、滚动容器。
- 将桌面端的表格列表改为卡片式列表与折叠详情，保留信息密度但更适配手机。

## 开发步骤
1. 新建 `miniprogram` 目录与基础工程（`app.json/app.js/app.wxss/project.config.json`）。
2. 抽象 `services` 与 `components`，搭建登录页与学生端核心页面（`index/profile/dorm/repair/bill/visitor/dorm_change`）。
3. 新建后端 `app/api` 蓝图与学生端 API；验证登录、Cookie、数据流。
4. 扩展宿管端页面与 API；完成审批与处理流程。
5. 扩展管理员端页面与 API；覆盖管理与统计功能。
6. 统一样式与交互细节；联调与验收。

## 验证与交付
- 提供本地运行说明（后端启动、小程序导入、开发者工具内“关闭域名校验”）。
- 页面自测清单（登录→首页→各功能模块→登出）。
- 代码交付：`miniprogram/` 全量、小程序配置及后端 `app/api/` 源码。